<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="null">
    <meta name="keyword" content="undefined">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        嵌入式syslog编译与使用 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="/css/style/default.css">-->
    <link href="/css/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 会当凌绝顶，一览众山小 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/head.jpg">
        </div>
        <div class="name">
            <i>bingone</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/blog/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#syslog"><span class="toc-text">syslog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate"><span class="toc-text">logrotate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建POPT库"><span class="toc-text">构建POPT库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建logrotate"><span class="toc-text">构建logrotate</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 会当凌绝顶，一览众山小 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        嵌入式syslog编译与使用
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-04-30 14:37:07</span></span>
        
        
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>busybox下的syslogd不能同时监控多个log，所以需要自己编译一个</p>
<h2 id="syslog"><a href="#syslog" class="headerlink" title="syslog"></a>syslog</h2><p>该工具在inetutils工具包内<br>首先下载安装包，然后解压，编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.gnu.org/gnu/inetutils/inetutils-1.5.tar.gz</span><br><span class="line">tar xvf inetutils-1.5.tar.gz &amp;&amp; cd inetutils-1.5</span><br><span class="line">CC=arm-none-linux-gnueabi-gcc LDFLAGS=-static ./configure --disable-clients --disable-ipv6 --disable-ncurses --host=arm --prefix=/opt/inetutils</span><br><span class="line">make</span><br></pre></td></tr></table></figure></p>
<p>之后可在src/下找到syslogd，将之复制到开发板的/sbin目录内</p>
<p>但syslog不支持多线程打印，当两条线程同时使用时，需要自行加锁<br>rsyslog是syslog的升级版，支持多线程<br>编译步骤一样，但需要多安装一些库,这里就不多说了</p>
<p>syslog可以通过配置文件控制日志的输出，但不能指定日志的大小<br>所以需要用到logrotate命令</p>
<h2 id="logrotate"><a href="#logrotate" class="headerlink" title="logrotate"></a>logrotate</h2><p>logrotate是linux中日志管理的重要工具，它可以自动对日志进行截断（或轮循）、压缩以及删除旧的日志文件。在发行版的桌面或者服务器linux系统中这个工具安装一般都是比较容易，或者默认已经自带，但是嵌入式系统一般需要通过源码来自己构建。</p>
<p>先安装编译依赖工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libtool-bin</span><br><span class="line">apt-get install autopoint</span><br></pre></td></tr></table></figure></p>
<h2 id="构建POPT库"><a href="#构建POPT库" class="headerlink" title="构建POPT库"></a>构建POPT库</h2><p>由于logrotate依赖于POPT库，所以要生成logrotate需要先构建POPT库，然后再利用POPT库构建logrotate。<br>下载最新的master分支源码包,并编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/devzero2000/POPT</span><br></pre></td></tr></table></figure></p>
<p>由于源码是基于autotools编译的，所以需要安装以下两个依赖工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libtool </span><br><span class="line">apt-get install autoconf</span><br></pre></td></tr></table></figure></p>
<p>第一次编译需要先生成configure,执行以下命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br></pre></td></tr></table></figure></p>
<p>之后就可以使用configure这个程序来生成Makefile了，比如下面就是生成 arm版的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/POPT --host=arm-linux</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>构建好后会在/opt/POPT 生成“include  lib  share” 三个目录，其中lib目录有logrotate编译和运行需要的库文件，include目录有我们编译logrotate需要的头文件。</p>
<h2 id="构建logrotate"><a href="#构建logrotate" class="headerlink" title="构建logrotate"></a>构建logrotate</h2><p>下载最新的源码logrotate,并编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/logrotate/logrotate </span><br><span class="line">./autogen.sh</span><br><span class="line">#./configure --host=arm-linux --prefix=/opt/logrotate LDFLAGS=-L/opt/POPT/lib CPPFLAGS=-I/opt/POPT/include</span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>其中LDFLAGS指定logrotate编译依赖库lpopt路径；而CPPFLAGS指定logrotate编译依赖头文件popt.h路径。<br>构建好后会在/opt/logrotate目录生成sbin/logrotate文件。</p>
<p>将/opt/POPT/lib/libpopt.so.0.0.0 复制到开发板的/lib下，并将名称改为libpopt.so.0<br>将/opt/logrotate/sbin/logrotate 复制到开发板的/sbin目录</p>
<p>编写一个配置文件,存放到开发板的/etc目录下，名称为logrotate.cfg<br>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/var/log/testlog.log &#123;</span><br><span class="line">     size=100k</span><br><span class="line">     rotate 2</span><br><span class="line">     postrotate</span><br><span class="line">                    /usr/bin/killall -HUP syslogd</span><br><span class="line">     endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>脚本的功能为监控/var/log/testlog.log,当该文件大于100k时，备份，最多备份2次，每次备份时，会kill掉syslogd，不过syslogd是会自动重启的不用担心</p>
<p>之后还需要启动一个定时任务来周期性调用logrotate命令</p>
<p>首先在开发板上创建/etc/cron目录<br>开机脚本写上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crond -c /etc/cron</span><br><span class="line">crontab -c /etc/cron /etc/cron/logrotate</span><br></pre></td></tr></table></figure></p>
<p>开机脚本每个系统都不太一样，就不说了<br>之后编写一个cron的配置文件放在/etc/cron目录下，文件名为logrotate<br>内容为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * logrotate /etc/logrotate.cfg</span><br></pre></td></tr></table></figure></p>
<p>内容的意思是每分钟执行一次logrotate，这样就可以自动备份转存日志了</p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.xml"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="/js/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="/js/busuanzi.pure.mini.js"></script>




</html>
